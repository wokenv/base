name: Build and Publish Docker Images

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'entrypoint.sh'
      - 'patches/**'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch:

env:
  DOCKER_IMAGE: frugan/wokenv

jobs:
  check-versions:
    name: Check wp-env Version
    runs-on: ubuntu-latest
    outputs:
      wpenv_version: ${{ steps.check.outputs.wpenv_version }}
      wpenv_major: ${{ steps.check.outputs.wpenv_major }}
      should_update_tracker: ${{ steps.check.outputs.should_update_tracker }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check wp-env version
        id: check
        run: |
          # Get latest wp-env version from npm
          LATEST_WPENV=$(npm view @wordpress/env version)
          WPENV_MAJOR=$(echo $LATEST_WPENV | cut -d. -f1)
          
          echo "wpenv_version=$LATEST_WPENV" >> $GITHUB_OUTPUT
          echo "wpenv_major=$WPENV_MAJOR" >> $GITHUB_OUTPUT
          
          echo "Latest wp-env: $LATEST_WPENV (major: $WPENV_MAJOR)"
          
          # Check if we need to update tracker (any version change)
          LAST_BUILT_FILE=".last-built-wpenv"
          if [ -f "$LAST_BUILT_FILE" ]; then
            LAST_BUILT=$(cat "$LAST_BUILT_FILE")
          else
            LAST_BUILT="0.0.0"
          fi
          
          if [ "$LATEST_WPENV" != "$LAST_BUILT" ]; then
            echo "should_update_tracker=true" >> $GITHUB_OUTPUT
            echo "wp-env version changed: $LAST_BUILT â†’ $LATEST_WPENV"
          else
            echo "should_update_tracker=false" >> $GITHUB_OUTPUT
            echo "wp-env version unchanged: $LATEST_WPENV"
          fi

  build-and-push:
    name: Build ${{ matrix.node }}-${{ matrix.variant }}-wpenv${{ needs.check-versions.outputs.wpenv_major }}
    needs: check-versions
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node: [18, 20, 22]
        variant: [alpine, bookworm]
        include:
          # Add LTS markers for popular versions
          - node: 20
            variant: alpine
            is_default: true
          - node: 20
            variant: bookworm
            is_lts: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        env:
          WPENV_MAJOR: ${{ needs.check-versions.outputs.wpenv_major }}
        with:
          images: ${{ env.DOCKER_IMAGE }}
          flavor: |
            latest=false
          tags: |
            # Full tag: node20-alpine-wpenv10
            type=raw,value=node${{ matrix.node }}-${{ matrix.variant }}-wpenv${{ needs.check-versions.outputs.wpenv_major }}
            # Short tag: node20-wpenv10 (for alpine only)
            type=raw,value=node${{ matrix.node }}-wpenv${{ needs.check-versions.outputs.wpenv_major }},enable=${{ matrix.variant == 'alpine' }}
            # Latest tag for default version
            type=raw,value=latest,enable=${{ matrix.is_default == true }}
            # Node version latest: node20-latest
            type=raw,value=node${{ matrix.node }}-latest,enable=${{ matrix.variant == 'alpine' }}
            # LTS tag
            type=raw,value=node${{ matrix.node }}-lts,enable=${{ matrix.is_lts == true }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NODE_VERSION=${{ matrix.node }}
            NODE_VARIANT=${{ matrix.variant }}
            WPENV_VERSION=${{ needs.check-versions.outputs.wpenv_major }}
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}
            VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Update version tracker
        if: needs.check-versions.outputs.should_update_tracker == 'true' && matrix.is_default == true
        run: |
          echo "${{ needs.check-versions.outputs.wpenv_version }}" > .last-built-wpenv
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last-built-wpenv
          git commit -m "chore: update wp-env to ${{ needs.check-versions.outputs.wpenv_version }}"
          git push

  update-docker-hub-description:
    name: Update Docker Hub Description
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKER_IMAGE }}
          short-description: "WordPress development environment with Node.js, Docker, and wp-env"
          readme-filepath: ./README.md
